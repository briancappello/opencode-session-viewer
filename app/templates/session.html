<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ session.summary.title }} | OpenCode Session Viewer</title>
    <!-- Markdown & Syntax Highlighting -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <!-- Application CSS -->
    <link rel="stylesheet" href="/static/css/base.css" />
    <link rel="stylesheet" href="/static/css/session.css" />
  </head>
  <body>
    <div class="container">
      <!-- prettier-ignore-start -->
      <script id="session-data" type="application/json">{{ session_json | safe }}</script>
      <!-- prettier-ignore-end -->

      <div class="sidebar" id="sidebar">
        <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
        <div class="sidebar-header">
          <div class="sidebar-title">
            <span>
              <a
                href="/"
                class="back-link"
                title="Back to sessions list"
                onclick="if (history.length > 1) { event.preventDefault(); history.back(); }"
                >‚Üê</a
              >
              {{ session.summary.title }}
            </span>
            <div class="session-actions">
              <button
                class="archive-btn"
                id="archiveBtn"
                onclick="toggleArchive()"
                title="Archive this session"
              >
                Archive
              </button>
              <button
                class="theme-toggle"
                onclick="toggleTheme()"
                title="Toggle dark mode"
              >
                üåì
              </button>
            </div>
          </div>
          <input
            type="text"
            class="search-box"
            placeholder="Search..."
            id="searchBox"
          />
        </div>
        <div class="filter-row">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="user">User</button>
          <button class="filter-btn" data-filter="assistant">Assistant</button>
        </div>
        <div class="stats-row" id="stats"></div>
        <div class="message-list" id="messageList"></div>
      </div>
      <div class="main-wrapper">
        <div class="scroll-container" id="mainContent">
          <div class="main-content">
            <div class="timeline" id="timeline">
              <!-- Loading state removed as data is injected -->
            </div>
          </div>
          <div class="viz-panel collapsed" id="vizPanel">
            <div class="viz-panel-header">
              <button
                class="viz-panel-toggle"
                id="vizPanelToggle"
                onclick="toggleVizPanel()"
                title="Expand stats panel"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <rect x="1.5" y="1.5" width="13" height="13" rx="2" />
                  <line x1="10.5" y1="1.5" x2="10.5" y2="14.5" />
                </svg>
              </button>
            </div>
            <div class="viz-panel-content">
              <div class="viz-section">
                <div class="viz-title">Current Message Tokens</div>
                <div class="current-tokens">
                  <div class="token-row">
                    <span class="token-label">Input</span>
                    <div class="token-bar-container">
                      <div
                        class="token-bar input"
                        id="inputBar"
                        style="width: 0%"
                      ></div>
                    </div>
                    <span class="token-value" id="inputValue">0</span>
                  </div>
                  <div class="token-row">
                    <span class="token-label">Output</span>
                    <div class="token-bar-container">
                      <div
                        class="token-bar output"
                        id="outputBar"
                        style="width: 0%"
                      ></div>
                    </div>
                    <span class="token-value" id="outputValue">0</span>
                  </div>
                  <div class="token-row">
                    <span class="token-label">Cache</span>
                    <div class="token-bar-container">
                      <div
                        class="token-bar cache"
                        id="cacheBar"
                        style="width: 0%"
                      ></div>
                    </div>
                    <span class="token-value" id="cacheValue">0</span>
                  </div>
                </div>
                <div class="legend">
                  <div class="legend-item">
                    <div class="legend-dot input"></div>
                    Input
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot output"></div>
                    Output
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot cache"></div>
                    Cache
                  </div>
                </div>
              </div>

              <div class="viz-section">
                <div class="viz-title">Cache Read Over Time</div>
                <div class="sparkline-container">
                  <svg class="sparkline-svg" id="sparkline"></svg>
                  <div class="sparkline-labels">
                    <span>Start</span>
                    <span>End</span>
                  </div>
                </div>
              </div>

              <div class="viz-section">
                <div class="viz-title">Timeline Progress</div>
                <div class="progress-bar-container">
                  <div
                    class="progress-bar"
                    id="progressBar"
                    style="width: 0%"
                  ></div>
                </div>
                <div class="progress-label" id="progressLabel">
                  Message 0 / 0
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Application JavaScript -->
    <script src="/static/js/base.js"></script>
    <script src="/static/js/session.js"></script>
  </body>
</html>
